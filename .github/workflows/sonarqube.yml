# name: Build Process
on:
  # pull_request:
  #   types:
  #     - opened
  #     - synchronize
  #     - reopened
  push:
    branches:
      - dev-v2
    paths:
      - 'Dockerfile'
      - '.github/workflows/**'
      - 'deployment.yaml'
jobs:
 build:
   runs-on: ubuntu-latest
   steps: 
   - name: Checkout master
     uses: actions/checkout@main
   - name: Install doctl
     uses: digitalocean/action-doctl@v2
     with:
       token: ${{secrets.DIGITALOCEAN_ACCESS_TOKEN}}

   - name: Build container image
     run: docker build -t ${{ secrets.REGISTRY_NAME }}/lafia-service:$(echo $GITHUB_SHA | head -c7) .

   - name: Log in to DigitalOcean Container Registry with short-lived credentials
     run: doctl registry login --expiry-seconds 600

  #  - name: Tag Image
  #    run:
  #       docker tag lafia.dcr/lafia-service \
  #       registry.digitalocean.com/lafia-dcr/lafia-service:${{github.event.input.version}}

   - name: Push image to DigitalOcean Container Registry
     run: docker push ${{ secrets.REGISTRY_NAME }}/lafia-service:$(echo $GITHUB_SHA | head -c7)

   - name: Update deployment file
     run: TAG=$(echo $GITHUB_SHA | head -c7) && sed -i 's|<IMAGE>|${{ secrets.REGISTRY_NAME }}/lafia-service:'${TAG}'|' $GITHUB_WORKSPACE/deployment.yaml
          
   - name: Save DigitalOcean kubeconfig with short-lived credentials
     run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 ${{ secrets.CLUSTER_NAME }}
   
    # If you haven't already integrated with your registry and only want workloads in a particular namespace to be able to pull 
    # from your registry, uncomment the next two commands.
    #- name: Upload credentials of your registry to your DigitalOcean Kubernetes cluster
    #  run: doctl registry kubernetes-manifest | kubectl apply -f -
      
    #- name: Reference the secret you just uploaded as an imagePullSecrets
    #  run: "kubectl patch serviceaccount default -p '{\"imagePullSecrets\": [{\"name\": \"registry-<your-registry-name>`\"}]}'"

   - name: Deploy to DigitalOcean Kubernetes
     run: kubectl apply -f $GITHUB_WORKSPACE/deployment.yaml

   - name: Verify deployment
     run: kubectl rollout status deployment/lafia-service
